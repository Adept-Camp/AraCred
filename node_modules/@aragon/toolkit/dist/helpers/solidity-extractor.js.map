{"version":3,"sources":["../../src/helpers/solidity-extractor.js"],"names":["SOLIDITY_SHORTHAND_TYPES_MAP","address","bytes","uint","int","ufixed","fixed","bool","string","SOLIDITY_BASIC_TYPES","Object","keys","modifiesStateAndIsPublic","declaration","match","typeOrAddress","type","some","t","startsWith","expandTypeForSignature","getSignature","name","params","split","replace","map","param","filter","s","length","join","getNotice","notices","x","getRoles","auths","authStatement","extractFunctions","sourceCode","functionDeclarations","stateModifyingFunctionDeclarations","functionDeclaration","sig","roles","notice","extractRoles","functionDescriptors","roleSet","Set","forEach","role","add","roleIds","id","extractContractInfo","roleDescriptors","functions"],"mappings":"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","sourcesContent":["import { keccak256 } from 'web3-utils'\n\n// See https://solidity.readthedocs.io/en/v0.4.24/abi-spec.html#types\nconst SOLIDITY_SHORTHAND_TYPES_MAP = {\n  address: 'address',\n  bytes: 'bytes',\n  uint: 'uint256',\n  int: 'int256',\n  ufixed: 'ufixed128x18',\n  fixed: 'fixed128x18',\n  bool: 'bool',\n  string: 'string',\n}\nconst SOLIDITY_BASIC_TYPES = Object.keys(SOLIDITY_SHORTHAND_TYPES_MAP)\n\nconst modifiesStateAndIsPublic = declaration =>\n  !declaration.match(/\\b(internal|private|view|pure|constant)\\b/)\n\n// Check if the type starts with any of the basic types, otherwise it is probably\n// a typed contract, so we need to return address for the signature\nconst typeOrAddress = type => {\n  return SOLIDITY_BASIC_TYPES.some(t => type.startsWith(t)) ? type : 'address'\n}\n\n// Expand shorthands into their full types for calculating function signatures\nconst expandTypeForSignature = type => {\n  return SOLIDITY_SHORTHAND_TYPES_MAP[type] || type\n}\n\n// extracts function signature from function declaration\nconst getSignature = declaration => {\n  let [name, params] = declaration\n    .match(/^\\s*function ([^]*?)\\)/m)[1]\n    .split('(')\n\n  if (!name) {\n    return 'fallback'\n  }\n\n  if (params) {\n    // Has parameters\n    params = params\n      .replace(/\\n/gm, '')\n      .replace(/\\t/gm, '')\n      .split(',')\n      .map(param => param.split(' ').filter(s => s.length > 0)[0])\n      .map(type => typeOrAddress(type))\n      .map(type => expandTypeForSignature(type))\n      .join(',')\n  }\n\n  return `${name}(${params})`\n}\n\nconst getNotice = declaration => {\n  // capture from @notice to either next '* @' or end of comment '*/'\n  const notices = declaration.match(/(@notice)([^]*?)(\\* @|\\*\\/)/m)\n  if (!notices || notices.length === 0) return null\n\n  return notices[0]\n    .replace('*/', '')\n    .replace('* @', '')\n    .replace('@notice ', '')\n    .replace(/\\n/gm, '')\n    .replace(/\\t/gm, '')\n    .split(' ')\n    .filter(x => x.length > 0)\n    .join(' ')\n}\n\n// extracts required role from function declaration\nconst getRoles = declaration => {\n  const auths = declaration.match(/auth.?\\(([^]*?)\\)/gm)\n  if (!auths) return []\n\n  return auths.map(\n    authStatement =>\n      authStatement\n        .split('(')[1]\n        .split(',')[0]\n        .split(')')[0]\n  )\n}\n\nconst extractFunctions = async sourceCode => {\n  // Everything between every 'function' and '{' and its @notice.\n  const functionDeclarations = sourceCode.match(\n    /(@notice|^\\s*function)(?:[^]*?){/gm\n  )\n\n  if (!functionDeclarations) {\n    return []\n  }\n\n  const stateModifyingFunctionDeclarations = functionDeclarations\n    .filter(functionDeclaration =>\n      modifiesStateAndIsPublic(functionDeclaration)\n    )\n    .map(functionDeclaration => ({\n      sig: getSignature(functionDeclaration),\n      roles: getRoles(functionDeclaration),\n      notice: getNotice(functionDeclaration),\n    }))\n\n  return stateModifyingFunctionDeclarations\n}\n\nconst extractRoles = async functionDescriptors => {\n  // Extract all role ids from the function descriptors.\n  const roleSet = new Set()\n  functionDescriptors.forEach(({ roles }) =>\n    roles.forEach(role => roleSet.add(role))\n  )\n  const roleIds = [...roleSet]\n\n  // Parse role ids into objects.\n  // TODO: Name and parameters are currently not being extracted, and it's probably better to get it from an AST instead of the Solidity code. For now, the properties are merely place holders.\n  return roleIds.map(id => ({\n    id,\n    bytes: keccak256(id),\n    name: '',\n    params: [],\n  }))\n}\n\n// Given a Solidity file, parses it and returns an object with the form:\n/*\n  roles: [\n    {\n      id: \"MINT_ROLE\",\n      bytes: \"0x0xbf05b9322505d747ab5880dfb677dc4864381e9fc3a25ccfa184a3a53d02f4b2\",\n      name: \"\",\n      params: []\n    },\n    ...\n  ],\n  functions: [\n    {\n      sig: \"baz(uint32,bool)\",\n      roles: [ \"MINT_ROLE\", \"BURN_ROLE\" ],\n      notice: \"Sample radspec documentation...\"\n    },\n    ...\n  ]\n*/\nexport const extractContractInfo = async sourceCode => {\n  const functionDescriptors = await extractFunctions(sourceCode)\n  const roleDescriptors = await extractRoles(functionDescriptors)\n\n  return {\n    roles: roleDescriptors,\n    functions: functionDescriptors,\n  }\n}\n"],"file":"solidity-extractor.js"}